{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{chatService}from'../services/chatService';import{useAuth}from'../App';import{toast}from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const Chat=_ref=>{let{contextType,contextId}=_ref;const{user}=useAuth();const[messages,setMessages]=useState([]);const[input,setInput]=useState('');const wsRef=useRef(null);useEffect(()=>{const token=localStorage.getItem('auth_token');let ws;let poller;async function init(){try{const msgs=await chatService.getMessages(contextType,contextId);setMessages(msgs);ws=chatService.connectWebSocket(contextType,contextId,token,msg=>{setMessages(prev=>[...prev,msg]);if(msg.sender_id!==(user===null||user===void 0?void 0:user.id)){toast(\"Nouveau message de \".concat(msg.sender_handle));}});poller=setInterval(async()=>{try{const updated=await chatService.getMessages(contextType,contextId);setMessages(updated);}catch(err){console.error('Failed to refresh chat',err);}},5000);wsRef.current=ws;}catch(err){console.error('Failed to load chat',err);}}init();return()=>{if(wsRef.current)wsRef.current.close();if(poller)clearInterval(poller);};},[contextType,contextId,user]);const send=async e=>{e.preventDefault();if(!input.trim())return;try{const newMessage=await chatService.postMessage(contextType,contextId,input.trim());setMessages(prev=>[...prev,newMessage]);setInput('');}catch(err){toast.error('Envoi échoué');}};return/*#__PURE__*/_jsxs(\"div\",{className:\"border rounded p-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"h-64 overflow-y-auto mb-4\",children:messages.map(m=>/*#__PURE__*/_jsxs(\"div\",{className:\"mb-1\",children:[/*#__PURE__*/_jsx(\"strong\",{children:m.sender_handle}),\": \",m.content]},m.id))}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:send,className:\"flex gap-2\",children:[/*#__PURE__*/_jsx(\"input\",{className:\"flex-1 border p-1 text-black bg-white\",value:input,onChange:e=>setInput(e.target.value)}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",className:\"bg-blue-500 text-white px-3\",children:\"Envoyer\"})]})]});};export default Chat;","map":{"version":3,"names":["React","useState","useEffect","useRef","chatService","useAuth","toast","jsx","_jsx","jsxs","_jsxs","Chat","_ref","contextType","contextId","user","messages","setMessages","input","setInput","wsRef","token","localStorage","getItem","ws","poller","init","msgs","getMessages","connectWebSocket","msg","prev","sender_id","id","concat","sender_handle","setInterval","updated","err","console","error","current","close","clearInterval","send","e","preventDefault","trim","newMessage","postMessage","className","children","map","m","content","onSubmit","value","onChange","target","type"],"sources":["C:/Users/Knight-Server/Desktop/VerseLink-Xapollo/frontend/src/components/Chat.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { chatService } from '../services/chatService';\nimport { useAuth } from '../App';\nimport { toast } from 'react-hot-toast';\n\nconst Chat = ({ contextType, contextId }) => {\n  const { user } = useAuth();\n  const [messages, setMessages] = useState([]);\n  const [input, setInput] = useState('');\n  const wsRef = useRef(null);\n\n  useEffect(() => {\n    const token = localStorage.getItem('auth_token');\n    let ws;\n    let poller;\n    async function init() {\n      try {\n        const msgs = await chatService.getMessages(contextType, contextId);\n        setMessages(msgs);\n        ws = chatService.connectWebSocket(contextType, contextId, token, (msg) => {\n          setMessages((prev) => [...prev, msg]);\n          if (msg.sender_id !== user?.id) {\n            toast(`Nouveau message de ${msg.sender_handle}`);\n          }\n        });\n        poller = setInterval(async () => {\n          try {\n            const updated = await chatService.getMessages(contextType, contextId);\n            setMessages(updated);\n          } catch (err) {\n            console.error('Failed to refresh chat', err);\n          }\n        }, 5000);\n        wsRef.current = ws;\n      } catch (err) {\n        console.error('Failed to load chat', err);\n      }\n    }\n    init();\n    return () => {\n      if (wsRef.current) wsRef.current.close();\n      if (poller) clearInterval(poller);\n    };\n  }, [contextType, contextId, user]);\n\n  const send = async (e) => {\n    e.preventDefault();\n    if (!input.trim()) return;\n    try {\n      const newMessage = await chatService.postMessage(contextType, contextId, input.trim());\n      setMessages((prev) => [...prev, newMessage]);\n      setInput('');\n    } catch (err) {\n      toast.error('Envoi échoué');\n    }\n  };\n\n  return (\n    <div className=\"border rounded p-4\">\n      <div className=\"h-64 overflow-y-auto mb-4\">\n        {messages.map(m => (\n          <div key={m.id} className=\"mb-1\">\n            <strong>{m.sender_handle}</strong>: {m.content}\n          </div>\n        ))}\n      </div>\n        <form onSubmit={send} className=\"flex gap-2\">\n          <input\n            className=\"flex-1 border p-1 text-black bg-white\"\n            value={input}\n            onChange={e => setInput(e.target.value)}\n          />\n          <button type=\"submit\" className=\"bg-blue-500 text-white px-3\">Envoyer</button>\n        </form>\n      </div>\n    );\n  };\n\nexport default Chat;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}